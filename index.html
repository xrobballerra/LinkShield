<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LinkShield Multi-Hoster</title>
  <style>
    :root { --gold: #FFD700; --green: #4ade80; --dark: #0f0f0f; --error: #ff4d4d; }
    body { background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; padding: 20px; line-height: 1.6; }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { text-align: center; color: var(--gold); letter-spacing: 1px; }
    
    .card { background: #161616; padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 20px; }
    input, button { width: 100%; padding: 14px; border-radius: 8px; background: #0a0a0a; color: white; border: 1px solid #444; font-size: 15px; outline: none; box-sizing: border-box; }
    
    button { background: var(--gold); color: black; font-weight: bold; margin-top: 10px; cursor: pointer; border: none; transition: 0.3s; }
    button:hover { filter: brightness(1.2); }
    button:disabled { background: #333; color: #777; cursor: not-allowed; }
    
    #result { margin-top: 20px; display: none; border-left: 4px solid var(--green); }
    .stream-link { background: #000; padding: 12px; border-radius: 6px; font-family: monospace; word-break: break-all; margin: 10px 0; border: 1px solid #222; font-size: 13px; color: var(--green); }
    .hoster-tag { font-size: 10px; text-transform: uppercase; background: #333; padding: 2px 6px; border-radius: 4px; color: #ccc; margin-bottom: 10px; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ¬ LinkShield</h1>
    
    <div class="card">
      <button id="pairBtn" onclick="startPairing()">ðŸ”— Link Real-Debrid Account</button>
      <div id="pairingBox" style="display:none; margin-top:15px; text-align:center;">
        <div id="codeDisplay" style="font-size:40px; color:var(--gold); font-weight:bold;">----</div>
        <p id="codeInstr" style="color:#888; font-size:13px;"></p>
      </div>
    </div>

    <div class="card">
      <label style="color:#888; font-size:12px;">Paste Any Supported Link (1fichier, Rapidgator, etc.)</label>
      <input id="link" placeholder="https://hoster.com/file/..." autocomplete="off">
      <button id="checkBtn" disabled onclick="checkLink()">Bypass Restrictions</button>
    </div>

    <div id="result" class="card">
      <div id="hosterInfo" class="hoster-tag">Detecting Hoster...</div>
      <div style="font-weight:bold; color:var(--green);">âœ… Link Unrestricted</div>
      <div id="filename" style="font-size:13px; color:#aaa; margin-top:5px;"></div>
      <div class="stream-link" id="finalLink"></div>
      <button id="dlBtn" style="background:var(--green); color:black;">ðŸš€ Download / Stream</button>
    </div>
  </div>

  <script>
    const CLIENT_ID = 'X245A4XAIBGVM';
    const PROXY = 'https://linkshield-proxy.vercel.app/api/proxy?url=';

    // UI Helpers
    const updateUI = (id, text) => document.getElementById(id).textContent = text;

    async function startPairing() {
      const pairBtn = document.getElementById('pairBtn');
      pairBtn.disabled = true;
      pairBtn.textContent = "Connecting to API...";

      try {
        const res = await fetch(`${PROXY}${encodeURIComponent(`https://api.real-debrid.com/oauth/v2/device/code?client_id=${CLIENT_ID}`)}`);
        const data = await res.json();
        
        document.getElementById('pairingBox').style.display = 'block';
        updateUI('codeDisplay', data.user_code);
        document.getElementById('codeInstr').innerHTML = `Visit <a href="${data.verification_url}" target="_blank" style="color:var(--gold)">real-debrid.com/device</a> and enter the code above.`;

        const poll = setInterval(async () => {
          const pollRes = await fetch(`${PROXY}${encodeURIComponent(`https://api.real-debrid.com/oauth/v2/device/credentials?client_id=${CLIENT_ID}&code=${data.device_code}`)}`);
          if (pollRes.status === 200) {
            const creds = await pollRes.json();
            clearInterval(poll);
            localStorage.setItem('rd_session', JSON.stringify({ id: creds.client_id, secret: creds.client_secret, device: data.device_code }));
            location.reload(); // Refresh to enable main UI
          }
        }, 5000);
      } catch (e) {
        pairBtn.disabled = false;
        alert("Setup failed. Check your proxy.");
      }
    }

    async function checkLink() {
      const btn = document.getElementById('checkBtn');
      const input = document.getElementById('link').value.trim();
      const session = JSON.parse(localStorage.getItem('rd_session'));
      
      if (!input) return alert("Please paste a link first.");
      
      btn.disabled = true;
      btn.textContent = "Unlocking...";
      document.getElementById('result').style.display = 'none';

      try {
        // 1. Refresh Access Token
        const tParams = new URLSearchParams({
          client_id: session.id,
          client_secret: session.secret,
          code: session.device,
          grant_type: 'http://oauth.net/grant_type/device/1.0'
        });

        const tRes = await fetch(`${PROXY}${encodeURIComponent('https://api.real-debrid.com/oauth/v2/token')}`, {
          method: 'POST',
          body: tParams.toString()
        });
        const tData = await tRes.json();

        // 2. Unrestrict the Link (Works for all hosters)
        const unParams = new URLSearchParams({ link: input });
        const unRes = await fetch(`${PROXY}${encodeURIComponent('https://api.real-debrid.com/rest/1.0/unrestrict/link')}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${tData.access_token}` },
          body: unParams.toString()
        });
        
        const data = await unRes.json();

        if (data.download) {
          document.getElementById('result').style.display = 'block';
          updateUI('hosterInfo', data.host.toUpperCase());
          updateUI('filename', data.filename);
          updateUI('finalLink', data.download);
          document.getElementById('dlBtn').onclick = () => window.open(data.download, '_blank');
        } else {
          alert("Error: " + (data.error || "Hoster not supported or link offline."));
        }
      } catch (err) {
        alert("Critical Error: " + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "Bypass Restrictions";
      }
    }

    window.onload = () => {
      if(localStorage.getItem('rd_session')) {
        document.getElementById('checkBtn').disabled = false;
        document.getElementById('pairBtn').textContent = "Account Connected âœ…";
        document.getElementById('pairBtn').style.background = "#222";
        document.getElementById('pairBtn').style.color = "#888";
      }
    };
  </script>
</body>
</html>
