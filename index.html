<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LinkShield</title>
  <style>
    :root { --gold: #FFD700; --green: #4ade80; --dark: #0f0f0f; }
    body { background: var(--dark); color: white; font-family: sans-serif; padding: 20px; }
    .container { max-width: 560px; margin: 0 auto; }
    input, button { width: 100%; padding: 14px; border-radius: 10px; background: #1a1a1a; color: white; border: 1px solid #333; }
    button { background: var(--gold); color: black; font-weight: bold; margin-top: 10px; }
    #result { margin-top: 20px; background: #1a1a1a; padding: 18px; border-radius: 12px; display: none; }
    .stream-link { background: #000; padding: 12px; border-radius: 8px; font-family: monospace; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé¨ LinkShield</h1>
    <button id="pairBtn" onclick="startPairing()">üîó Pair with Real-Debrid</button>
    <div id="codeDisplay" style="display:none; margin:20px 0; text-align:center; font-size:32px; color:var(--gold)"></div>
    <div id="codeInstr" style="display:none; text-align:center; color:#aaa; margin-bottom:20px"></div>

    <div>
      <label>Paste hoster link (cached)</label>
      <input id="link" value="https://1fichier.com/?q7w8e9r0t1y2u3i4o5p6">
      <button id="checkBtn" disabled onclick="checkLink()">CallCheck</button>
    </div>
    <div id="result"></div>
  </div>

  <script>
    // üîê TOS-Compliant: Open-source client ID (no secret exposed)
    const CLIENT_ID = 'X245A4XAIBGVM';
    const PROXY = 'https://linkshield-proxy.vercel.app/api/proxy?url=';

    async function startPairing() {
      const res = await fetch(`${PROXY}${encodeURIComponent(`https://api.real-debrid.com/oauth/v2/device/code?client_id=${CLIENT_ID}`)}`);
      const { user_code, verification_url, device_code, interval } = await res.json();
      document.getElementById('codeDisplay').textContent = user_code;
      document.getElementById('codeDisplay').style.display = 'block';
      document.getElementById('codeInstr').innerHTML = `Go to: <a href="${verification_url}" target="_blank">${verification_url}</a><br>Enter code ‚Üí Approve`;
      document.getElementById('codeInstr').style.display = 'block';

      // Poll for credentials
      const poll = async () => {
        const r = await fetch(`${PROXY}${encodeURIComponent(`https://api.real-debrid.com/oauth/v2/device/credentials?client_id=${CLIENT_ID}&code=${device_code}`)}`);
        if (r.ok) {
          const { client_id, client_secret } = await r.json();
          localStorage.setItem('rd_client_id', client_id);
          localStorage.setItem('rd_client_secret', client_secret);
          localStorage.setItem('rd_device_code', device_code);
          document.getElementById('checkBtn').disabled = false;
          document.getElementById('codeInstr').innerHTML = '‚úÖ Paired!';
        } else setTimeout(poll, interval * 1000);
      };
      poll();
    }

    async function checkLink() {
      const link = document.getElementById('link').value.trim();
      const client_id = localStorage.getItem('rd_client_id');
      const client_secret = localStorage.getItem('rd_client_secret');
      const device_code = localStorage.getItem('rd_device_code');

      // Get access token
      const tokenRes = await fetch(`${PROXY}${encodeURIComponent('https://api.real-debrid.com/oauth/v2/token')}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `client_id=${client_id}&client_secret=${client_secret}&code=${device_code}&grant_type=http://oauth.net/grant_type/device/1.0`
      });
      const { access_token } = await tokenRes.json();

      // Unrestrict link
      const unrestrictRes = await fetch(`${PROXY}${encodeURIComponent('https://api.real-debrid.com/rest/1.0/unrestrict/link')}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${access_token}`,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `link=${encodeURIComponent(link)}`
      });

      const data = await unrestrictRes.json();
      if (!data.download) throw new Error(data.error || 'No stream');

      document.getElementById('result').innerHTML = `
        <div style="color:var(--green)">‚úÖ Real ‚Äî Cached</div>
        <div class="stream-link">${data.download}</div>
        <button onclick="window.open('${data.download}')" style="margin-top:10px">‚ñ∂Ô∏è Play</button>
      `;
      document.getElementById('result').style.display = 'block';
    }
  </script>
</body>
</html>
