<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LinkShield</title>
  <style>
    :root { --gold: #FFD700; --green: #4ade80; --dark: #0f0f0f; }
    body { background: var(--dark); color: white; font-family: sans-serif; padding: 20px; }
    .container { max-width: 560px; margin: 0 auto; }
    input, button { width: 100%; padding: 14px; border-radius: 10px; background: #1a1a1a; color: white; border: 1px solid #333; outline: none; box-sizing: border-box; }
    button { background: var(--gold); color: black; font-weight: bold; margin-top: 10px; cursor: pointer; border: none; }
    button:disabled { background: #444; cursor: not-allowed; color: #888; }
    #result { margin-top: 20px; background: #1a1a1a; padding: 18px; border-radius: 12px; display: none; border: 1px solid #333; }
    .stream-link { background: #000; padding: 12px; border-radius: 8px; font-family: monospace; word-break: break-all; margin-top: 10px; border: 1px solid #222; }
    a { color: var(--gold); text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ¬ LinkShield</h1>
    <button id="pairBtn" onclick="startPairing()">ðŸ”— Pair with Real-Debrid</button>
    
    <div id="pairingBox" style="display:none; background:#1a1a1a; padding:20px; border-radius:10px; margin:20px 0; text-align:center; border:1px dashed var(--gold);">
      <div id="codeDisplay" style="font-size:36px; color:var(--gold); font-weight:bold; margin-bottom:10px;"></div>
      <div id="codeInstr" style="color:#aaa; font-size:14px;"></div>
    </div>

    <div style="margin-top:20px;">
      <label style="color:#888; font-size:12px; display:block; margin-bottom:5px;">Hoster Link</label>
      <input id="link" placeholder="https://..." value="https://1fichier.com/?q7w8e9r0t1y2u3i4o5p6">
      <button id="checkBtn" disabled onclick="checkLink()">CallCheck</button>
    </div>
    <div id="result"></div>
  </div>

  <script>
    const CLIENT_ID = 'X245A4XAIBGVM';
    const PROXY = 'https://linkshield-proxy.vercel.app/api/proxy?url=';

    async function startPairing() {
      const pairBtn = document.getElementById('pairBtn');
      pairBtn.disabled = true;
      pairBtn.textContent = "Connecting...";

      try {
        const url = `https://api.real-debrid.com/oauth/v2/device/code?client_id=${CLIENT_ID}`;
        const res = await fetch(`${PROXY}${encodeURIComponent(url)}`);
        const data = await res.json();
        
        document.getElementById('pairingBox').style.display = 'block';
        document.getElementById('codeDisplay').textContent = data.user_code;
        document.getElementById('codeInstr').innerHTML = `Go to <a href="${data.verification_url}" target="_blank">real-debrid.com/device</a> and enter the code.`;

        const interval = setInterval(async () => {
          const checkUrl = `https://api.real-debrid.com/oauth/v2/device/credentials?client_id=${CLIENT_ID}&code=${data.device_code}`;
          const pollRes = await fetch(`${PROXY}${encodeURIComponent(checkUrl)}`);
          
          if (pollRes.status === 200) {
            const creds = await pollRes.json();
            clearInterval(interval);
            localStorage.setItem('rd_creds', JSON.stringify({
              id: creds.client_id,
              secret: creds.client_secret,
              code: data.device_code
            }));
            finishPairing();
          }
          // Note: 403 Forbidden here is normal until you approve the code.
        }, 5000);
      } catch (err) {
        pairBtn.disabled = false;
        pairBtn.textContent = "Error - Try Again";
      }
    }

    function finishPairing() {
      document.getElementById('pairingBox').style.display = 'none';
      document.getElementById('checkBtn').disabled = false;
      document.getElementById('pairBtn').textContent = "Linked âœ…";
    }

    async function checkLink() {
      const btn = document.getElementById('checkBtn');
      const resDiv = document.getElementById('result');
      const linkVal = document.getElementById('link').value.trim();
      const creds = JSON.parse(localStorage.getItem('rd_creds'));

      btn.disabled = true;
      btn.textContent = "Processing...";

      try {
        // 1. Get Access Token
        const tokenParams = new URLSearchParams({
          client_id: creds.id,
          client_secret: creds.secret,
          code: creds.code,
          grant_type: 'http://oauth.net/grant_type/device/1.0'
        });

        const tRes = await fetch(`${PROXY}${encodeURIComponent('https://api.real-debrid.com/oauth/v2/token')}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: tokenParams.toString()
        });
        const tData = await tRes.json();
        if (!tData.access_token) throw new Error("Auth failed");

        // 2. Unrestrict
        const unParams = new URLSearchParams({ link: linkVal });
        const unRes = await fetch(`${PROXY}${encodeURIComponent('https://api.real-debrid.com/rest/1.0/unrestrict/link')}`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${tData.access_token}`,
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: unParams.toString()
        });
        const data = await unRes.json();

        if (data.download) {
          resDiv.innerHTML = `<div style="color:var(--green)">âœ… Success!</div><div class="stream-link">${data.download}</div>`;
          resDiv.style.display = 'block';
        } else {
          throw new Error(data.error || "Unrestrict failed");
        }
      } catch (err) {
        alert("CallCheck Error: " + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "CallCheck";
      }
    }

    window.onload = () => {
      if(localStorage.getItem('rd_creds')) finishPairing();
    };
  </script>
</body>
</html>
